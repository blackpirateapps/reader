<!DOCTYPE html>
<html lang="en" data-theme="white" data-font="serif">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Clean Reader</title>
    <!-- Same Liquid Glass CSS as before, omitted for brevity but fully functional -->
    <style>
        :root {
            --glass-bg: rgba(255, 255, 255, 0.65);
            --glass-border: rgba(255, 255, 255, 0.4);
            --glass-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
            --glass-blur: blur(20px);
            --text-main: #1d1d1f;
            --text-secondary: #86868b;
            --accent: #007aff;
            --danger: #ff3b30;
            --reader-bg: #ffffff;
            --reader-text: #333333;
        }
        body {
            margin: 0; font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            background-color: #f0f0f5;
            background-image: radial-gradient(at 0% 0%, hsla(253,16%,7%,1) 0, transparent 50%), radial-gradient(at 100% 0%, hsla(339,49%,30%,1) 0, transparent 50%);
            background-attachment: fixed; min-height: 100vh; color: var(--text-main);
        }
        body.reading-mode { background: var(--reader-bg) !important; color: var(--reader-text); }
        .hidden { display: none !important; }
        .glass-panel { background: var(--glass-bg); backdrop-filter: var(--glass-blur); border: 1px solid var(--glass-border); border-radius: 24px; box-shadow: var(--glass-shadow); }
        .container { max-width: 700px; margin: 0 auto; padding: 20px; }
        button { cursor: pointer; border: none; font-family: inherit; }
        input { width: 100%; box-sizing: border-box; background: rgba(255,255,255,0.5); padding: 14px; border-radius: 16px; border: 1px solid rgba(255,255,255,0.3); outline: none; }
        
        /* Specific UI Elements */
        #login-screen { height: 100vh; display: flex; align-items: center; justify-content: center; }
        .login-box { padding: 40px; width: 300px; text-align: center; }
        .login-btn { width: 100%; background: var(--text-main); color: white; padding: 14px; border-radius: 16px; margin-top: 15px; font-weight: bold; }
        
        .article-list { list-style: none; padding: 0; display: flex; flex-direction: column; gap: 15px; }
        .article-card { padding: 20px; display: flex; justify-content: space-between; transition: transform 0.2s; }
        .article-card:hover { transform: translateY(-2px); background: rgba(255,255,255,0.8); }
        .card-content { flex: 1; }
        .card-title { font-weight: 700; font-size: 17px; margin-bottom: 5px; cursor: pointer; }
        .card-meta { font-size: 13px; color: var(--text-secondary); }
        .card-actions { display: flex; gap: 10px; margin-left: 15px; opacity: 0; transition: opacity 0.2s; }
        .article-card:hover .card-actions { opacity: 1; }
        .icon-btn { width: 32px; height: 32px; border-radius: 50%; background: rgba(0,0,0,0.05); display: flex; align-items: center; justify-content: center; }
        
        /* Reader */
        .reader-nav { position: fixed; top: 0; left: 0; right: 0; padding: 15px 20px; background: var(--reader-bg); border-bottom: 1px solid rgba(0,0,0,0.1); display: flex; justify-content: space-between; opacity: 0.95; z-index: 10; }
        .article-body { margin-top: 80px; padding-bottom: 100px; line-height: 1.6; font-size: 1.2rem; }
        .article-body img { max-width: 100%; height: auto; border-radius: 8px; margin: 20px 0; }
        
        /* Themes */
        [data-theme="sepia"] { --reader-bg: #f8f1e3; --reader-text: #4f321c; }
        [data-theme="black"] { --reader-bg: #000000; --reader-text: #ccc; }
    </style>
</head>
<body>

    <div id="login-screen">
        <div class="glass-panel login-box">
            <h2>Clean Reader</h2>
            <input type="password" id="secretKeyInput" placeholder="Enter Key">
            <button class="login-btn" onclick="handleLogin()">Unlock</button>
        </div>
    </div>

    <div id="app-screen" class="hidden container">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <h1 style="margin:0;">Library</h1>
            <button onclick="handleLogout()" style="background:transparent; color:var(--text-secondary);">Log Out</button>
        </div>

        <div style="display:flex; gap:10px; margin-bottom:20px;">
            <input type="url" id="urlInput" placeholder="https://..." style="background:white;">
            <button onclick="doAction('save')" style="background:var(--accent); color:white; padding:0 20px; border-radius:16px; font-weight:bold;">Save</button>
        </div>
        <div id="status" style="text-align:center; height:20px; font-size:13px; color:var(--text-secondary); margin-bottom:10px;"></div>

        <div style="display:flex; gap:10px; margin-bottom:20px;">
            <input type="text" id="searchInput" placeholder="Search..." onkeyup="handleSearch(this.value)">
            <button onclick="switchView('inbox')" id="btn-inbox" style="font-weight:bold;">Inbox</button>
            <button onclick="switchView('archive')" id="btn-archive" style="color:var(--text-secondary);">Archive</button>
        </div>

        <ul id="list" class="article-list"></ul>
    </div>

    <div id="reader-screen" class="hidden container">
        <nav class="reader-nav">
            <button onclick="closeReader()" style="background:transparent; color:var(--accent); font-weight:bold; font-size:16px;">‚Üê Back</button>
            <button onclick="toggleTheme()" style="background:transparent; font-size:16px;">aA</button>
        </nav>
        <div id="reader-content" class="article-body"></div>
    </div>

    <script>
        const API_URL = '/api/library';
        let view = 'inbox';

        function getHeaders() {
            return { 'Content-Type': 'application/json', 'x-auth-key': localStorage.getItem('clean_reader_key') };
        }

        async function api(type, method = 'GET', body = null, params = {}) {
            let url = `${API_URL}?type=${type}`;
            if(params.q) url += `&q=${params.q}`;
            if(params.archived) url += `&archived=${params.archived}`;
            if(params.id) url += `&id=${params.id}`;

            const res = await fetch(url, {
                method,
                headers: getHeaders(),
                body: body ? JSON.stringify({ ...body, type }) : null
            });
            if(res.status === 401) { handleLogout(); return null; }
            return res.json();
        }

        // --- ACTIONS ---

        async function doAction(action, payload = {}) {
            const status = document.getElementById('status');
            
            if (action === 'save') {
                const url = document.getElementById('urlInput').value;
                if(!url) return;
                status.innerText = "Processing...";
                const res = await api('save', 'POST', { url });
                if(res.success) {
                    status.innerText = "Saved!";
                    document.getElementById('urlInput').value = "";
                    loadList();
                } else {
                    status.innerText = "Error saving.";
                }
                setTimeout(() => status.innerText = "", 2000);
            }
            
            if (action === 'archive' || action === 'unarchive') {
                await api('archive', 'POST', { id: payload.id, action });
                loadList();
            }

            if (action === 'delete') {
                if(!confirm("Delete forever?")) return;
                await api('delete', 'POST', { id: payload.id });
                loadList();
            }
        }

        async function loadList() {
            const isArchived = view === 'archive';
            const data = await api('list', 'GET', null, { archived: isArchived });
            renderList(data);
        }

        let searchTimer;
        function handleSearch(q) {
            clearTimeout(searchTimer);
            if(q.length < 2) { if(q.length===0) loadList(); return; }
            searchTimer = setTimeout(async () => {
                const data = await api('search', 'GET', null, { q });
                renderList(data);
            }, 300);
        }

        function renderList(items) {
            const list = document.getElementById('list');
            if(!items || items.length === 0) { list.innerHTML = "<div style='text-align:center; color:gray;'>Empty</div>"; return; }
            
            list.innerHTML = items.map(item => `
                <li class="glass-panel article-card">
                    <div class="card-content">
                        <div class="card-title" onclick="openReader(${item.id})">${item.title}</div>
                        <div class="card-meta">${new Date(item.created_at).toLocaleDateString()}</div>
                    </div>
                    <div class="card-actions">
                        <button class="icon-btn" onclick="doAction('${view === 'inbox' ? 'archive' : 'unarchive'}', {id:${item.id}})">${view === 'inbox' ? 'üì•' : '‚ôªÔ∏è'}</button>
                        <button class="icon-btn" onclick="doAction('delete', {id:${item.id}})" style="color:var(--danger)">üóë</button>
                    </div>
                </li>
            `).join('');
        }

        async function openReader(id) {
            document.getElementById('app-screen').classList.add('hidden');
            document.getElementById('reader-screen').classList.remove('hidden');
            document.body.classList.add('reading-mode');
            document.getElementById('reader-content').innerHTML = "Loading...";
            
            const data = await api('read', 'GET', null, { id });
            document.getElementById('reader-content').innerHTML = `
                <h1 style="line-height:1.1;">${data.title}</h1>
                <p style="color:gray; font-size:0.9em; margin-bottom:40px;"><a href="${data.url}" target="_blank" style="color:var(--accent);">Original</a></p>
                ${data.content}
            `;
        }

        function closeReader() {
            document.getElementById('reader-screen').classList.add('hidden');
            document.getElementById('app-screen').classList.remove('hidden');
            document.body.classList.remove('reading-mode');
        }

        // --- APP SHELL ---
        function init() {
            if(localStorage.getItem('clean_reader_key')) {
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('app-screen').classList.remove('hidden');
                loadList();
            }
        }
        function handleLogin() {
            localStorage.setItem('clean_reader_key', document.getElementById('secretKeyInput').value);
            init();
        }
        function handleLogout() { localStorage.clear(); location.reload(); }
        function switchView(v) { 
            view = v; 
            document.getElementById('btn-inbox').style.color = v==='inbox'?'black':'gray';
            document.getElementById('btn-archive').style.color = v==='archive'?'black':'gray';
            document.getElementById('searchInput').value = '';
            loadList(); 
        }
        
        let themeIdx = 0;
        const themes = ['white', 'sepia', 'black'];
        function toggleTheme() {
            themeIdx = (themeIdx + 1) % themes.length;
            document.documentElement.setAttribute('data-theme', themes[themeIdx]);
        }

        init();
    </script>
</body>
</html>