<!DOCTYPE html>
<html lang="en" data-theme="paper">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Feeds - Clean Reader</title>
    <link rel="stylesheet" href="style.css">
    <script src="theme.js"></script>
    <style>
        /* Feed List Styles */
        .feed-controls { display: flex; gap:10px; margin-bottom: 20px; padding: 15px; background: var(--surface-color); border: 1px solid var(--border); border-radius: 8px;}
        .feed-item-row { display: flex; justify-content: space-between; align-items: flex-start; gap: 10px; padding: 15px 0; border-bottom: 1px solid var(--border); }
        .feed-meta { font-size: 0.8rem; color: var(--text-muted); margin-top: 4px; text-transform: uppercase; letter-spacing: 0.05em; }
        .feed-title { font-weight: 600; font-size: 1rem; color: var(--text-main); cursor: pointer; }
        .feed-title:hover { color: var(--accent); }
        .feed-actions { display: flex; gap: 10px; min-width: 80px; justify-content: flex-end;}
        .sub-list { font-size: 0.9rem; margin-bottom: 30px; border-bottom: 2px solid var(--text-main); padding-bottom: 15px; }
        .sub-tag { display: inline-block; padding: 4px 8px; background: var(--surface-color); border: 1px solid var(--border); border-radius: 4px; margin: 0 5px 5px 0; }

        /* Preview Modal Styles */
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 900; backdrop-filter: blur(2px); }
        .modal { 
            position: fixed; top: 5%; left: 50%; transform: translateX(-50%); 
            width: 90%; max-width: 800px; height: 90%; 
            background: var(--bg-color); border: 1px solid var(--border); 
            border-radius: 8px; z-index: 1000; display: flex; flex-direction: column; 
            box-shadow: 0 20px 50px rgba(0,0,0,0.3);
        }
        .modal-header { padding: 15px 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; background: var(--surface-color); border-radius: 8px 8px 0 0; }
        .modal-title { font-weight: 700; font-family: var(--font-serif); font-size: 1.2rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 80%; }
        .modal-actions-bar { padding: 10px 20px; border-bottom: 1px solid var(--border); background: var(--bg-color); display: flex; justify-content: space-between; align-items: center;}
        
        /* The Content Area */
        #preview-content { 
            padding: 40px; 
            overflow-y: auto; 
            flex: 1; 
            font-family: var(--reader-font-family, serif); /* Use Reader Font */
            font-size: 1.1rem;
            line-height: 1.6;
        }
        #preview-content img { max-width: 100%; height: auto; display: block; margin: 20px auto; }
        #preview-content p { margin-bottom: 1.5em; }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <div class="brand">Feeds.</div>
            <div style="display:flex; gap:15px; align-items:center;">
                <a href="index.html" class="logout" style="text-decoration:none;">&larr; Library</a>
            </div>
        </header>

        <div class="feed-controls">
            <input type="text" id="new-feed-url" placeholder="Paste RSS/Atom URL..." style="border:none;">
            <button class="btn-save" onclick="addFeed()">Add</button>
            <button class="btn-icon" onclick="refreshFeeds()" title="Refresh All">ðŸ”„</button>
        </div>

        <div id="sub-list" class="sub-list">Loading subscriptions...</div>

        <h3 style="margin-bottom:20px;">Unread Items</h3>
        <div id="feed-list" class="article-list">
            Loading items...
        </div>
    </div>

    <div id="preview-overlay" class="overlay hidden" onclick="closePreview()"></div>
    <div id="preview-modal" class="modal hidden">
        <div class="modal-header">
            <div id="preview-title" class="modal-title">Title</div>
            <button onclick="closePreview()" class="btn-icon" style="font-size:1.5rem;">&times;</button>
        </div>
        <div class="modal-actions-bar">
            <button id="btn-save-preview" class="btn-save" onclick="saveCurrentPreview()">ðŸ’¾ Save to Library</button>
            <a id="btn-open-original" href="#" target="_blank" class="logout" style="font-size:0.9rem;">Open Original ðŸ”—</a>
        </div>
        <div id="preview-content">
            </div>
    </div>

    <script>
        const API_FEED = '/api/feeds';
        const API_LIB = '/api/library';
        const KEY = localStorage.getItem('clean_reader_key');

        if(!KEY) window.location.href = 'index.html';

        let currentPreviewUrl = null;

        async function api(endpoint, type, body={}) {
            const res = await fetch(`${endpoint}?type=${type}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'x-auth-key': KEY },
                body: JSON.stringify({ ...body, type })
            });
            return res.json();
        }

        async function init() {
            loadSubs();
            loadItems();
        }

        // --- FEED MANAGEMENT ---

        async function addFeed() {
            const url = document.getElementById('new-feed-url').value;
            if(!url) return;
            document.querySelector('.btn-save').innerText = "...";
            await api(API_FEED, 'add_feed', { url });
            document.getElementById('new-feed-url').value = "";
            document.querySelector('.btn-save').innerText = "Add";
            init();
        }

        async function refreshFeeds() {
            const btn = document.querySelector('button[title="Refresh All"]');
            btn.innerText = "â³";
            const res = await api(API_FEED, 'refresh_feeds');
            btn.innerText = "ðŸ”„";
            if(res.new_items > 0) alert(`Found ${res.new_items} new items.`);
            loadItems();
        }

        async function loadSubs() {
            const subs = await api(API_FEED, 'get_subscriptions');
            const div = document.getElementById('sub-list');
            if(subs.length === 0) { div.innerHTML = "No subscriptions yet."; return; }
            
            div.innerHTML = subs.map(s => `
                <div class="sub-tag">
                    ${s.title} 
                    <span style="cursor:pointer; color:red; margin-left:5px;" onclick="deleteFeed(${s.id})">Ã—</span>
                </div>
            `).join('');
        }

        async function deleteFeed(id) {
            if(!confirm("Remove this feed?")) return;
            await api(API_FEED, 'delete_feed', { id });
            init();
        }

        async function loadItems() {
            const items = await api(API_FEED, 'get_unread');
            const list = document.getElementById('feed-list');
            
            if(items.length === 0) {
                list.innerHTML = "<div style='text-align:center; padding:20px; color:var(--text-muted)'>All caught up.</div>";
                return;
            }

            list.innerHTML = items.map(item => `
                <div class="feed-item-row" id="row-${item.id}">
                    <div style="flex:1;">
                        <div class="feed-title" onclick="openPreview('${item.url}', ${item.id})">${item.title}</div>
                        <div class="feed-meta">
                            ${item.feed_title} &bull; ${new Date(item.pub_date).toLocaleDateString()}
                        </div>
                    </div>
                    <div class="feed-actions">
                        <button class="btn-icon" title="Mark as Read" onclick="markRead(${item.id})">âœ“</button>
                    </div>
                </div>
            `).join('');
        }

        async function markRead(id) {
            const row = document.getElementById(`row-${id}`);
            if(row) {
                row.style.opacity = '0.5';
                setTimeout(() => row.remove(), 500);
            }
            await api(API_FEED, 'mark_read', { id });
        }

        // --- PREVIEW LOGIC ---

        async function openPreview(url, id) {
            // 1. Reset Modal UI
            document.getElementById('preview-overlay').classList.remove('hidden');
            document.getElementById('preview-modal').classList.remove('hidden');
            document.getElementById('preview-title').innerText = "Loading...";
            document.getElementById('preview-content').innerHTML = "<div style='text-align:center; margin-top:50px;'>Fetching content...</div>";
            
            const btnSave = document.getElementById('btn-save-preview');
            btnSave.disabled = true;
            btnSave.innerText = "ðŸ’¾ Save to Library";

            // 2. Mark as read in list (Optimistic)
            markRead(id);

            // 3. Fetch Preview
            try {
                const res = await fetch(`${API_FEED}?type=preview&url=${encodeURIComponent(url)}`, {
                    headers: { 'x-auth-key': KEY }
                });
                const data = await res.json();
                
                if(data.error) throw new Error(data.error);

                // 4. Render
                document.getElementById('preview-title').innerText = data.title;
                document.getElementById('preview-content').innerHTML = data.content;
                document.getElementById('btn-open-original').href = data.url;
                
                // Enable Save
                currentPreviewUrl = data.url;
                btnSave.disabled = false;

            } catch(e) {
                document.getElementById('preview-content').innerHTML = `<div style="text-align:center; color:red; margin-top:50px;">Error loading preview: ${e.message}</div>`;
            }
        }

        function closePreview() {
            document.getElementById('preview-overlay').classList.add('hidden');
            document.getElementById('preview-modal').classList.add('hidden');
            currentPreviewUrl = null;
        }

        async function saveCurrentPreview() {
            if(!currentPreviewUrl) return;
            const btn = document.getElementById('btn-save-preview');
            const originalText = btn.innerText;
            btn.innerText = "Saving...";
            
            try {
                const res = await fetch(`${API_LIB}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'x-auth-key': KEY },
                    body: JSON.stringify({ type: 'save', url: currentPreviewUrl })
                });
                const data = await res.json();

                if(data.success) {
                    btn.innerText = "Saved!";
                    btn.disabled = true;
                } else {
                    throw new Error("API returned failure");
                }
            } catch(e) {
                alert("Error saving to library.");
                btn.innerText = originalText;
            }
        }

        init();
    </script>
</body>
</html>